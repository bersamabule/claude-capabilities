# Spec-to-Implementation Bridge - Code Generator

Generate implementation code from specifications.

## Usage

`/spec-generate [spec-file]` - Generate code from spec
`/spec-generate [spec-file] --types` - Generate only types/interfaces
`/spec-generate [spec-file] --client` - Generate API client
`/spec-generate [spec-file] --server` - Generate server stubs
`/spec-generate [spec-file] --all` - Generate everything
`/spec-generate:setup [spec-type]` - Set up code generation tooling

## Instructions

### Step 1: Detect Spec Type

Identify the specification type:

| Spec Type | Detection |
|-----------|-----------|
| OpenAPI 3.x | `openapi: "3.` or `"openapi": "3.` |
| OpenAPI 2.x (Swagger) | `swagger: "2.` or `"swagger": "2.` |
| GraphQL | `.graphql`, `.gql`, or `type Query` |
| Prisma | `.prisma` or `datasource db` |
| Protocol Buffers | `.proto` or `syntax = "proto` |
| JSON Schema | `"$schema":` |
| AsyncAPI | `asyncapi:` |

### Step 2: Check for Existing Generator Config

Look for existing codegen setup:

| Spec Type | Config Files |
|-----------|--------------|
| OpenAPI | `openapitools.json`, `orval.config.ts`, `swagger-typescript-api` |
| GraphQL | `codegen.yml`, `codegen.ts`, `graphql.config.js` |
| Prisma | `schema.prisma` (built-in) |
| Proto | `buf.yaml`, `buf.gen.yaml` |

If config exists, use it. Otherwise, offer to set up.

### Step 3: Generate Code by Spec Type

#### OpenAPI Generation

**Available Generators**:

| Generator | Output | Best For |
|-----------|--------|----------|
| `openapi-typescript` | TypeScript types | Type-only, lightweight |
| `openapi-generator-cli` | Full client/server | Comprehensive |
| `orval` | React Query/SWR hooks | React apps |
| `swagger-typescript-api` | TypeScript client | Simple client |
| `@hey-api/openapi-ts` | Modern TS client | TypeScript-first |

**Type Generation** (`--types`):

```typescript
// Generated from api/openapi.yaml
// DO NOT EDIT - Generated by Spec-to-Implementation Bridge

export interface User {
  id: string;
  email: string;
  name: string;
  createdAt: string;
  updatedAt: string;
}

export interface CreateUserRequest {
  email: string;
  name: string;
  password: string;
}

export interface UserResponse {
  user: User;
}

export interface UsersListResponse {
  users: User[];
  total: number;
  page: number;
  pageSize: number;
}

// Enums
export type UserRole = 'admin' | 'user' | 'guest';

// Path parameters
export interface GetUserByIdParams {
  id: string;
}

// Query parameters
export interface ListUsersQuery {
  page?: number;
  pageSize?: number;
  search?: string;
}
```

**Client Generation** (`--client`):

```typescript
// Generated API client from api/openapi.yaml
// DO NOT EDIT - Generated by Spec-to-Implementation Bridge

import { User, CreateUserRequest, UserResponse, UsersListResponse } from './types';

export class ApiClient {
  constructor(private baseUrl: string, private headers: Record<string, string> = {}) {}

  // GET /users
  async listUsers(query?: ListUsersQuery): Promise<UsersListResponse> {
    const params = new URLSearchParams(query as any);
    const response = await fetch(`${this.baseUrl}/users?${params}`, {
      headers: this.headers,
    });
    if (!response.ok) throw new ApiError(response);
    return response.json();
  }

  // GET /users/{id}
  async getUserById(id: string): Promise<UserResponse> {
    const response = await fetch(`${this.baseUrl}/users/${id}`, {
      headers: this.headers,
    });
    if (!response.ok) throw new ApiError(response);
    return response.json();
  }

  // POST /users
  async createUser(body: CreateUserRequest): Promise<UserResponse> {
    const response = await fetch(`${this.baseUrl}/users`, {
      method: 'POST',
      headers: { ...this.headers, 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!response.ok) throw new ApiError(response);
    return response.json();
  }

  // DELETE /users/{id}
  async deleteUser(id: string): Promise<void> {
    const response = await fetch(`${this.baseUrl}/users/${id}`, {
      method: 'DELETE',
      headers: this.headers,
    });
    if (!response.ok) throw new ApiError(response);
  }
}
```

**Server Stubs** (`--server`):

```typescript
// Generated server stubs from api/openapi.yaml
// Implement the handlers below

import { Router } from 'express';
import {
  ListUsersQuery,
  CreateUserRequest,
  UserResponse,
  UsersListResponse
} from './types';

const router = Router();

// GET /users
router.get('/users', async (req, res) => {
  const query: ListUsersQuery = req.query;

  // TODO: Implement listUsers
  // Expected response: UsersListResponse
  throw new Error('Not implemented: listUsers');
});

// GET /users/:id
router.get('/users/:id', async (req, res) => {
  const { id } = req.params;

  // TODO: Implement getUserById
  // Expected response: UserResponse
  throw new Error('Not implemented: getUserById');
});

// POST /users
router.post('/users', async (req, res) => {
  const body: CreateUserRequest = req.body;

  // TODO: Implement createUser
  // Expected response: UserResponse (201 Created)
  throw new Error('Not implemented: createUser');
});

// DELETE /users/:id
router.delete('/users/:id', async (req, res) => {
  const { id } = req.params;

  // TODO: Implement deleteUser
  // Expected response: 204 No Content
  throw new Error('Not implemented: deleteUser');
});

export default router;
```

#### GraphQL Generation

**Available Generators**:

| Generator | Output | Best For |
|-----------|--------|----------|
| `@graphql-codegen/typescript` | TypeScript types | Types only |
| `@graphql-codegen/typescript-resolvers` | Resolver types | Server |
| `@graphql-codegen/typescript-react-apollo` | React hooks | Apollo Client |
| `@graphql-codegen/typescript-urql` | URQL hooks | URQL |

**Type Generation**:

```typescript
// Generated from schema.graphql
// DO NOT EDIT - Generated by Spec-to-Implementation Bridge

export type Maybe<T> = T | null;

export interface User {
  __typename?: 'User';
  id: string;
  email: string;
  name: string;
  posts: Post[];
}

export interface Post {
  __typename?: 'Post';
  id: string;
  title: string;
  content: string;
  author: User;
}

export interface Query {
  __typename?: 'Query';
  users: User[];
  user?: Maybe<User>;
  posts: Post[];
}

export interface Mutation {
  __typename?: 'Mutation';
  createUser: User;
  updateUser: User;
  deleteUser: boolean;
}

// Resolver types
export interface Resolvers {
  Query: QueryResolvers;
  Mutation: MutationResolvers;
  User: UserResolvers;
  Post: PostResolvers;
}
```

#### Prisma Generation

Prisma generates automatically. Run:

```bash
npx prisma generate
```

Output includes:
- Type-safe client at `node_modules/.prisma/client`
- TypeScript types for all models

#### Protocol Buffers Generation

**Using buf**:

```yaml
# buf.gen.yaml
version: v1
plugins:
  - plugin: buf.build/protocolbuffers/js
    out: src/generated
  - plugin: buf.build/grpc/web
    out: src/generated
```

### Step 4: Generator Setup (`/spec-generate:setup`)

If no generator configured, offer to set up:

#### OpenAPI Setup

```bash
# Option 1: openapi-typescript (types only)
npm install -D openapi-typescript
npx openapi-typescript api/openapi.yaml -o src/generated/api-types.ts

# Option 2: orval (React Query hooks)
npm install -D orval
# Creates orval.config.ts

# Option 3: openapi-generator-cli (comprehensive)
npm install -D @openapitools/openapi-generator-cli
npx openapi-generator-cli generate -i api/openapi.yaml -g typescript-fetch -o src/generated/api
```

Create `package.json` script:

```json
{
  "scripts": {
    "generate:api": "openapi-typescript api/openapi.yaml -o src/generated/api-types.ts"
  }
}
```

#### GraphQL Setup

```bash
npm install -D @graphql-codegen/cli @graphql-codegen/typescript
npx graphql-codegen init
```

Create `codegen.yml`:

```yaml
schema: schema.graphql
generates:
  src/generated/graphql.ts:
    plugins:
      - typescript
      - typescript-resolvers
```

Add script:

```json
{
  "scripts": {
    "generate:graphql": "graphql-codegen"
  }
}
```

### Step 5: Output Results

```markdown
## Code Generation Complete

**Spec**: `api/openapi.yaml` (OpenAPI 3.0)
**Generator**: openapi-typescript

### Generated Files

| File | Contents |
|------|----------|
| `src/generated/api-types.ts` | 15 interfaces, 3 enums |
| `src/generated/api-client.ts` | API client with 8 methods |

### Usage Example

```typescript
import { ApiClient } from './generated/api-client';
import type { User, CreateUserRequest } from './generated/api-types';

const api = new ApiClient('https://api.example.com');

// Type-safe API calls
const users = await api.listUsers({ page: 1 });
const newUser = await api.createUser({
  email: 'test@example.com',
  name: 'Test User',
  password: 'secret'
});
```

### Next Steps

1. Import generated types in your code
2. Replace manual type definitions with generated ones
3. Run `/spec-drift` to verify implementation matches spec
4. Add `generate:api` to your build pipeline

### Regeneration

Run `npm run generate:api` after spec changes.
```

## Integration

- **Dependency Doctor**: Ensures codegen dependencies are installed
- **Test & Check**: Verifies generated code compiles
- **PR Reviewer**: Suggests regeneration when spec changes
- **Chronicle**: Records generation events
